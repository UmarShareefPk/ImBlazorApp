@page "/Incidents"
@using IM.Models

<div class="container px-8">
    <br />
    <h1>Incidents</h1>
    <br />

    <input type="text" class="line-textbox w-50" placeholder="Search" />
    <br />

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th class="text-nowrap" scope="col">Title</th>
                <th class="text-nowrap" scope="col">Description</th>
                <th class="text-nowrap" scope="col">Assigned TO</th>
                <th class="text-nowrap" scope="col">Created By</th>
                <th class="text-nowrap" scope="col">Created Date</th>
                <th class="text-nowrap" scope="col">Due Date</th>
                <th class="text-nowrap" scope="col">Status</th>
            </tr>
        </thead>
        <tbody>
            @if(incidents != null)
            {
                @foreach(Incident incident in incidents)
                {
                     <IncidentRow incident="@incident"></IncidentRow>
                }
            }           
        
        </tbody>

    </table>
</div>
    <Pagination pageNumber="@pageNumber" totalRecords="@totalRecords" pageSizeOrNumberChanged="ReloadIncidents"></Pagination>

</div>

@code {

    //int PageSize, int PageNumber, string SortBy, string SortDirection, string Search;
    List<Incident> incidents;
    IncidentPages incidentPages;
    int totalRecords;
    int pageNumber = 1;
    int pageSize;

    protected override async Task OnInitializedAsync()
    {
    }

    private async Task ReloadIncidents(dynamic pageInfo)
    {
        pageSize = pageInfo.pSize;
        pageNumber = pageInfo.pNumber;

         GetIncidents(pageSize, pageNumber, "");
         StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            GetIncidents(5, 1, "");
           
        }
    }

    private async Task GetIncidents(int pageSize, int pageNumber, string search)
    {
          string token = await localStorage.GetItemAsync<string>("token");
            var request = new HttpRequestMessage(HttpMethod.Get,
             configuration.GetSection("APIURL").Value + "/Incidents/GetIncidentsWithPage?PageSize=" + pageSize + "&PageNumber=" + pageNumber + "&SortBy=a&SortDirection=a&Search="+ search);

            request.Headers.Add("Authorization", "Bearer " + token);


            var client = ClientFactory.CreateClient();

            var response = await client.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                using var responseStream = await response.Content.ReadAsStreamAsync();
                incidentPages = await JsonSerializer.DeserializeAsync<IncidentPages>(responseStream);
                incidents = incidentPages.Incidents;
                totalRecords = incidentPages.Total_Incidents;
                 StateHasChanged();
            }
            else
            {

            }
    }

     
}
